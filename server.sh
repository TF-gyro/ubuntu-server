export DEBIAN_FRONTEND=noninteractive

apt -yq update;
apt -yq upgrade;
apt-get -yq install lsb-release ca-certificates apt-transport-https software-properties-common;
ufw allow OpenSSH;
ufw allow Postfix;
ufw allow 80;
ufw allow 8080;
ufw allow 3000;
ufw allow 443;
ufw allow 587;
yes | ufw enable;
apt-get -yq install mysql-server;
apt-get -yq install php;
apt-get -yq install php-cli;
apt-get -yq install php-fpm;
apt-get -yq install php-mysql;
apt-get -yq install php-curl;
apt-get -yq install php-mbstring;
apt-get -yq install php-mysql;
apt-get -yq install php-curl;
apt-get -yq install php-gd;
apt-get -yq install php-zip;
apt-get -yq install php-xml;
php_ver="$(cut -d '.' -f 1 <<< "$(php -r "echo phpversion();")")"."$(cut -d '.' -f 2 <<< "$(php -r "echo phpversion();")")";
apt-get -yq install net-tools;
apt-get -yq install zip;
apt-get -yq install unzip;
apt-get -yq install p7zip-full;
apt-get -yq install nginx;
apt-get -yq install build-essential;
apt-get -yq install curl;
apt-get -yq install s3cmd;
apt-get -yq install htop;
apt-get -yq install poppler-utils;
apt-get -yq install python3-pip;
apt-get -yq install imagemagick;
apt-get -yq install ffmpeg;
echo 'post_max_size = 1024M' | tee -a /etc/php/$php_ver/fpm/php.ini;
echo 'upload_max_filesize = 1024M' | tee -a /etc/php/$php_ver/fpm/php.ini;
echo 'memory_limit = 2048M' | tee -a /etc/php/$php_ver/fpm/php.ini;
yes | curl -sS https://getcomposer.org/installer -o /tmp/composer-setup.php;
yes | php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer;
yes | systemctl disable --now apache2;
echo "ALTER USER 'mysql_root_user'@'localhost' IDENTIFIED WITH mysql_native_password BY 'mysql_root_pass'; FLUSH PRIVILEGES; exit;" | mysql;
echo 'expire_logs_days = 3' | tee -a /etc/mysql/mysql.conf.d/mysqld.cnf;
echo 'binlog_expire_logs_seconds = 86400' | tee -a /etc/mysql/mysql.conf.d/mysqld.cnf;
snap install --classic certbot;
apt-get -yq install python3-certbot-nginx;
/bin/dd if=/dev/zero of=/var/swap.1 bs=1M count=1024;
/sbin/mkswap /var/swap.1;
/sbin/swapon /var/swap.1;
service php$php_ver-fpm restart;
apt -yq update;
systemctl start nginx;
systemctl reload nginx;
